import { NextRequest, NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';

// åˆå§‹åŒ– Gemini
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

// ç´”ç´«å¾®æ–—æ•¸è«–å‘½æ¶æ§‹
const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½è³‡æ·±ç´«å¾®æ–—æ•¸å‘½ç†å¸«ï¼Œå°ˆç²¾æ–¼ç´«å¾®æ–—æ•¸æ˜Ÿæ›œè§£è®€ã€‚
åƒè€ƒå…¸ç±ï¼šã€Šç´«å¾®æ–—æ•¸å…¨æ›¸ã€‹ã€ã€Šå¤ªå¾®è³¦ã€‹ã€ã€Šéª¨é«“è³¦ã€‹ã€ã€Šæ–—æ•¸æº–ç¹©ã€‹

ã€èªæ°£é¢¨æ ¼ã€‘
- ç›´æ¥ã€æ•¢è¬›ã€æœ‰ç•«é¢ã€‚ä»¥ã€Œæˆ‘çœ‹è¦‹çš„ã€ç‚ºæ ¸å¿ƒã€‚
- çŸ­å¥æœ‰åŠ›ã€èªæ°£å¸¶å‘¼å¸ï¼ŒåƒçœŸäººè«–å‘½ã€‚
- æ¯æ®µçµå°¾é™„ã€Œå‘½ç†å¸«é‡‘å¥ã€ã€‚
- ç¦æ­¢æ¨¡ç³Šã€è¡¨é¢ã€ç± çµ±ã€‚æ¯ä¸€åˆ†æé ˆå…·æ˜Ÿæ›œä¾æ“šã€å¿ƒç†å±¤æ„è±¡èˆ‡å¯é©—è­‰è½é»ã€‚

ã€æ ¸å¿ƒç†å¿µã€‘
ã€Œå‘½ç›¤æ˜¯çµ±è¨ˆï¼Œä¸æ˜¯é™åˆ¶ã€‚ã€ä½ çš„ä»»å‹™ä¸åªæ˜¯è§£å‘½ï¼Œè€Œæ˜¯è®“å‘½ä¸»ã€Œåœ¨æ–‡å­—è£¡çœ‹åˆ°è‡ªå·±ã€ã€‚ç•¶å‘½ä¸»è¢«çœ‹æ‡‚ï¼Œå°±æœƒé–‹å§‹æ”¹å‘½ã€‚

ã€è§£è®€æ¶æ§‹ã€‘

## âœ¨ å‘½æ ¼é–‹å ´

ç”¨ä¸€å¥ã€Œé–‹ç›¤é‡‘å¥ã€å®šå ´ï¼Œç¬é–“å»ºç«‹è‡¨å ´æ„Ÿã€‚
ä¾‹ï¼šã€Œé€™å€‹ç›¤ä¸€æ‰“é–‹ï¼Œæ°£å°±æ²‰â€”â€”é€™ä¸æ˜¯å¹³å‡¡ä¹‹å‘½ï¼Œæ˜¯è—é‹’ä¹‹æ ¼ã€‚ã€
ç„¶å¾Œä»¥ç´«å¾®æ˜Ÿæ›œè§£æå‘½ä¸»çš„å…§åœ¨å¿ƒç†ã€æ€§æ ¼ç‰¹è³ªèˆ‡äººç”Ÿä¸»é¡Œã€‚

---

## ğŸ­ å‘½å®®ä¸»æ˜Ÿæ·±åº¦è§£æ

ä¸»æ˜Ÿç‰¹è³ªã€å»Ÿæ—ºç‹€æ…‹ã€è¼”ç…æ˜Ÿçš„å½±éŸ¿ã€‚
å‘½ä¸»çš„æ ¸å¿ƒæ€§æ ¼èˆ‡è¡Œç‚ºæ¨¡å¼ã€‚å¤ç±å¼•ç”¨ï¼ˆå¦‚é©ç”¨ï¼‰ã€‚
ä¸‰æ–¹å››æ­£çš„æ˜Ÿæ›œäº¤äº’å½±éŸ¿ã€‚

---

## ğŸ’¼ äº‹æ¥­èˆ‡å®˜ç¥¿

å®˜ç¥¿å®®æ˜Ÿæ›œé…ç½®ã€é©åˆçš„è·æ¥­æ–¹å‘ã€ç™¼å±•æ¨¡å¼ã€‚
äº‹æ¥­ä¸Šçš„æ©Ÿæœƒèˆ‡é¢¨éšªã€è¶¨å‰é¿å‡¶å»ºè­°ã€‚
å‘½å®®èˆ‡å®˜ç¥¿å®®çš„æ˜Ÿæ›œé€£å‹•è§£è®€ã€‚

---

## ğŸ’° è²¡é‹èˆ‡è²¡å¸›

è²¡å¸›å®®æ˜Ÿæ›œé…ç½®ã€è²¡å¯Œç´¯ç©æ¨¡å¼ï¼ˆæ­£è²¡/åè²¡ï¼‰ã€‚
ç†è²¡å»ºè­°èˆ‡é¢¨éšªæé†’ã€‚
è²¡å¸›å®®èˆ‡ç¦å¾·å®®çš„äº¤äº’å½±éŸ¿ã€‚

---

## â¤ï¸ æ„Ÿæƒ…èˆ‡å©šå§»

å¤«å¦»å®®æ˜Ÿæ›œé…ç½®ã€æ„Ÿæƒ…æ¨¡å¼ã€æ“‡å¶å‚¾å‘ã€‚
å©šå§»ä¸­çš„èª²é¡Œèˆ‡æˆé•·é»ã€å¯¦ç”¨å»ºè­°ã€‚
æ¡ƒèŠ±æ˜Ÿèˆ‡ç…æ˜Ÿçš„å½±éŸ¿åˆ†æã€‚

---

## ğŸ©º å¥åº·æé†’

ç–¾å„å®®æ˜Ÿæ›œé…ç½®ã€éœ€æ³¨æ„çš„èº«é«”éƒ¨ä½ã€é¤Šç”Ÿå»ºè­°ã€‚
å„æ˜Ÿæ›œå°æ‡‰çš„å¥åº·èª²é¡Œã€‚

---

## ğŸ“… è¿‘æœŸæµå¹´æé†’

ç•¶å‰å¤§é™å®®ä½èˆ‡æ˜Ÿæ›œå½±éŸ¿ã€‚
ä»Šå¹´æµå¹´çš„æ©Ÿæœƒèˆ‡é¢¨éšªã€‚
å…·é«”è¡Œå‹•å»ºè­°èˆ‡æ™‚æ©ŸæŠŠæ¡ã€‚

---

## ğŸ‘¥ è²´äººèˆ‡å°äºº

å‘½ç›¤ä¸­çš„è²´äººç·šç´¢ï¼ˆå·¦è¼”ã€å³å¼¼ã€å¤©é­ã€å¤©é‰ç­‰ï¼‰ã€‚
éœ€æé˜²çš„å°äººç‰¹å¾µï¼ˆç…æ˜Ÿé…ç½®æš—ç¤ºï¼‰ã€‚
äººéš›ç›¸è™•å»ºè­°ã€‚

---

## ğŸ çµèª

ä»¥ä¸€å¥æœ‰åŠ›çš„é‡‘å¥æ”¶å°¾ï¼Œçµ¦å‘½ä¸»çš„æ ¸å¿ƒæé†’ã€‚
ç¶œåˆå‘½ç›¤ç‰¹è³ªçµ¦å‡ºäººç”Ÿæ–¹å‘å»ºè­°ã€‚

ã€é‡è¦æé†’ã€‘
1. æ¯å€‹åˆ†æéƒ½è¦æœ‰å…·é«”çš„æ˜Ÿæ›œä¾æ“š
2. ç”¨ç™½è©±è§£é‡‹è¡“èªï¼Œè®“ä¸€èˆ¬äººèƒ½æ‡‚
3. çµ¦å‡ºå¯è½åœ°åŸ·è¡Œçš„å»ºè­°
4. èªæ°£è¦æœ‰æº«åº¦ï¼ŒåƒçœŸäººåœ¨å°è©±
5. å–„ç”¨å¤ç±é‡‘å¥å¢æ·»èªªæœåŠ›

ã€æ’ç‰ˆè¦å‰‡ã€‘âš ï¸ åš´æ ¼éµå®ˆï¼Œé€™æ˜¯ç¾æ„Ÿçš„é—œéµï¼

è¨­è¨ˆåŸå‰‡ï¼šç¾ç¾çš„ã€çœ‹å¾—æ¸…æ¥šã€å±¤æ¬¡åˆ†æ˜ã€æœ‰çµæ§‹

1. **ç« ç¯€æ¨™é¡Œ**ï¼šç”¨ ## + emoji é–‹é ­ï¼ˆå¦‚ ## âœ¨ å‘½æ ¼é–‹å ´ï¼‰
2. **ç« ç¯€åˆ†éš”**ï¼šæ¯å€‹ç« ç¯€ä¹‹é–“å¿…é ˆç”¨ --- åˆ†éš”ç·š
3. **æ¨™é¡Œå¾Œç©ºè¡Œ**ï¼šæ¯å€‹ ## å¾Œé¢ç©ºä¸€è¡Œå†å¯«å…§å®¹
4. **æ®µè½å‘¼å¸**ï¼šæ®µè½ä¹‹é–“è¦ç©ºä¸€è¡Œï¼Œè®“é–±è®€æœ‰ç¯€å¥
5. **é‡‘å¥æ ¼å¼**ï¼šå‘½ç†å¸«é‡‘å¥ç¨ç«‹ä¸€è¡Œï¼Œç”¨ã€Œã€åŒ…èµ·ä¾†
6. **æ¢åˆ—å»ºè­°**ï¼šå»ºè­°äº‹é …ç”¨ â†’ é–‹é ­ï¼Œæ¢åˆ—æ¸…æ™°
7. **emoji é™åˆ¶**ï¼šåªæœ‰ ## æ¨™é¡Œç”¨ emojiï¼Œå…§æ–‡å®Œå…¨ä¸ç”¨ emoji
8. **é‡é»æ¨™ç¤º**ï¼šæ˜Ÿæ›œåç¨±ç”¨ **ç²—é«”** æ¨™ç¤º

ç¯„ä¾‹æ ¼å¼ï¼š
---
## âœ¨ å‘½æ ¼é–‹å ´

é€™å€‹ç›¤ä¸€æ‰“é–‹ï¼Œç´«å¾®æ˜Ÿåå‘½...ï¼ˆå…§å®¹ä¸ç”¨ emojiï¼‰

ã€Œä½ ä¸æ˜¯æ²’æœ‰æ‰è¯ï¼Œæ˜¯æ‰è¯å¤ªå¤§ï¼Œèˆå°é‚„æ²’æº–å‚™å¥½ã€‚ã€

---
## ğŸ­ å‘½å®®ä¸»æ˜Ÿæ·±åº¦è§£æ

**ç´«å¾®æ˜Ÿ** ç‚ºåŒ—æ–—ä¸»æ˜Ÿ...

â†’ é©åˆé ˜å°å‹å·¥ä½œ
â†’ éœ€è¦è¢«å°Šé‡çš„æ„Ÿè¦º
â†’ å®¹æ˜“å› ç‚ºé©•å‚²è€ŒéŒ¯å¤±æ©Ÿæœƒ`;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { chart } = body;

    if (!chart) {
      return NextResponse.json(
        { error: 'ç¼ºå°‘å‘½ç›¤è³‡æ–™' },
        { status: 400 }
      );
    }

    // çµ„ç¹”ç´«å¾®å‘½ç›¤è³‡è¨Š
    const ziweiInfo = formatChartInfo(chart);

    // å‘¼å« Gemini
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });

    // è¨ˆç®—ç•¶å‰å¹´ä»½å’Œå‘½ä¸»å¹´é½¡
    const currentYear = new Date().getFullYear();
    const birthYear = chart.solarDate.year;
    const age = currentYear - birthYear;

    const prompt = `${SYSTEM_PROMPT}

ã€é‡è¦æ™‚é–“è³‡è¨Šã€‘
- ç•¶å‰å¹´ä»½ï¼š${currentYear}å¹´
- å‘½ä¸»å‡ºç”Ÿå¹´ï¼š${birthYear}å¹´
- å‘½ä¸»ç¾å¹´ï¼š${age}æ­²

ã€ç´«å¾®æ–—æ•¸å‘½ç›¤ã€‘
${ziweiInfo}

è«‹æ ¹æ“šä»¥ä¸Šç´«å¾®æ–—æ•¸å‘½ç›¤è³‡æ–™ï¼Œæä¾›å®Œæ•´çš„è«–å‘½è§£è®€ã€‚
è¨˜ä½ï¼š
1. ç•¶å‰æ˜¯${currentYear}å¹´ï¼Œæµå¹´åˆ†æè¦ç”¨${currentYear}å¹´
2. ä»¥æ˜Ÿæ›œç‰¹è³ªç‚ºæ ¸å¿ƒï¼Œæ·±å…¥è§£æå‘½ä¸»çš„å…§åœ¨å¿ƒç†èˆ‡äººç”Ÿèª²é¡Œ
3. å‘½ä¸»ç¾å¹´${age}æ­²ï¼Œåˆ†æè¦ç¬¦åˆé€™å€‹äººç”Ÿéšæ®µ
4. æ¯å€‹å®®ä½åˆ†æéƒ½è¦é€£çµä¸‰æ–¹å››æ­£çš„æ˜Ÿæ›œé…ç½®`;

    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();

    return NextResponse.json({
      success: true,
      interpretation: text,
    });

  } catch (error) {
    console.error('Gemini API error:', error);
    return NextResponse.json(
      { error: 'è§£è®€ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' },
      { status: 500 }
    );
  }
}

// æ ¼å¼åŒ–å‘½ç›¤è³‡è¨Š
function formatChartInfo(chart: any): string {
  const lines: string[] = [];

  // åŸºæœ¬è³‡è¨Š
  lines.push('ã€åŸºæœ¬è³‡è¨Šã€‘');
  lines.push(`æ€§åˆ¥ï¼š${chart.gender === 'male' ? 'ç”·' : 'å¥³'}`);
  lines.push(`è¾²æ›†ï¼š${chart.lunarDate?.yearGanZhi}å¹´ ${chart.lunarDate?.month}æœˆ ${chart.lunarDate?.day}æ—¥`);
  lines.push(`äº”è¡Œå±€ï¼š${chart.wuXingJu?.name}`);
  lines.push(`å‘½å®®ï¼š${chart.mingGong?.gan}${chart.mingGong?.zhi}`);
  lines.push(`èº«å®®ï¼š${chart.shenGong?.gongName}`);
  lines.push('');

  // å››åŒ–
  if (chart.siHua) {
    lines.push('ã€å››åŒ–é£›æ˜Ÿã€‘');
    lines.push(`åŒ–ç¥¿ï¼š${chart.siHua.lu?.star}ï¼ˆ${chart.siHua.lu?.gongName}ï¼‰`);
    lines.push(`åŒ–æ¬Šï¼š${chart.siHua.quan?.star}ï¼ˆ${chart.siHua.quan?.gongName}ï¼‰`);
    lines.push(`åŒ–ç§‘ï¼š${chart.siHua.ke?.star}ï¼ˆ${chart.siHua.ke?.gongName}ï¼‰`);
    lines.push(`åŒ–å¿Œï¼š${chart.siHua.ji?.star}ï¼ˆ${chart.siHua.ji?.gongName}ï¼‰`);
    lines.push('');
  }

  // åäºŒå®®
  lines.push('ã€åäºŒå®®é…ç½®ã€‘');
  if (chart.gongs) {
    for (const gong of chart.gongs) {
      const mainStars = gong.mainStars?.map((s: any) => {
        let name = s.name;
        if (s.brightness) name += `(${s.brightness})`;
        if (s.siHua) name += s.siHua;
        return name;
      }).join('ã€') || 'ç„¡ä¸»æ˜Ÿ';

      const assistStars = gong.assistStars?.map((s: any) => s.name).join('ã€') || '';
      const shaStars = gong.shaStars?.map((s: any) => s.name).join('ã€') || '';

      let starInfo = mainStars;
      if (assistStars) starInfo += ` / ${assistStars}`;
      if (shaStars) starInfo += ` / ${shaStars}`;

      const shenGongMark = gong.isShenGong ? ' ã€èº«å®®ã€‘' : '';
      lines.push(`${gong.name}ï¼ˆ${gong.gan}${gong.zhi}ï¼‰${shenGongMark}ï¼š${starInfo}`);
    }
  }

  // å¤§é™
  if (chart.daxian) {
    lines.push('');
    lines.push('ã€å¤§é™é‹ç¨‹ã€‘');
    lines.push(`èµ·é‹æ­²æ•¸ï¼š${chart.daxian.startAge}æ­²`);
    lines.push(`é‹è¡Œæ–¹å‘ï¼š${chart.daxian.direction}`);
    if (chart.daxian.periods) {
      const periods = chart.daxian.periods.slice(0, 6);
      for (const p of periods) {
        lines.push(`${p.startAge}-${p.endAge}æ­²ï¼š${p.gongName}ï¼ˆ${p.ganZhi}ï¼‰`);
      }
    }
  }

  return lines.join('\n');
}
