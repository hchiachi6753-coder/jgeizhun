<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ§­ é¢¨æ°´ç¾…ç›¤ - Jå€‹æº–</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans TC', sans-serif;
      background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2b 100%);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      padding: 15px;
      min-height: 100vh;
    }
    
    /* é ‚éƒ¨æ¨™é¡Œ */
    .header {
      text-align: center;
      padding: 15px 0;
    }
    
    .header h1 {
      font-size: 26px;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }
    
    .header p {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
    }
    
    /* æˆæ¬Šæç¤ºå€å¡Š */
    .permission-box {
      background: linear-gradient(135deg, rgba(255,107,107,0.3), rgba(255,159,67,0.3));
      border: 2px solid #ff6b6b;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 15px;
      text-align: center;
      animation: pulse-border 2s infinite;
    }
    
    @keyframes pulse-border {
      0%, 100% { border-color: #ff6b6b; box-shadow: 0 0 20px rgba(255,107,107,0.3); }
      50% { border-color: #ffd700; box-shadow: 0 0 30px rgba(255,215,0,0.4); }
    }
    
    .permission-box.granted {
      background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(34,197,94,0.2));
      border-color: #4ade80;
      animation: none;
    }
    
    .permission-box h3 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .permission-box p {
      font-size: 13px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 12px;
    }
    
    .btn-permission {
      width: 100%;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #ff6b6b, #ff8c00);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-permission:disabled {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }
    
    /* ç¾…ç›¤å€å¡Š */
    .compass-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
    }
    
    .compass-wrapper {
      position: relative;
      width: 260px;
      height: 260px;
    }
    
    /* ç¾…ç›¤ SVG */
    .compass-svg {
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 0 20px rgba(255,215,0,0.3));
    }
    
    /* æŒ‡é‡å®¹å™¨ */
    .needle-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: transform 0.2s ease-out;
    }
    
    /* åº¦æ•¸é¡¯ç¤º */
    .degree-display {
      text-align: center;
      margin-top: 15px;
    }
    
    .degree-value {
      font-size: 48px;
      font-weight: bold;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .direction-text {
      font-size: 22px;
      color: #4ade80;
      margin-top: 3px;
    }
    
    /* æ‹ç…§å€å¡Š */
    .photo-section {
      padding: 15px 0;
    }
    
    .btn-photo {
      width: 100%;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #1a1a2e;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .btn-photo:disabled {
      background: #444;
      color: #888;
    }
    
    #camera-input { display: none; }
    
    /* ç…§ç‰‡è¨ˆæ•¸ */
    .photo-count {
      text-align: center;
      color: rgba(255,255,255,0.7);
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .photo-count span {
      color: #ffd700;
      font-weight: bold;
    }
    
    /* ç…§ç‰‡åˆ—è¡¨ */
    .photo-list {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    
    .photo-list::-webkit-scrollbar {
      height: 6px;
    }
    
    .photo-list::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }
    
    .photo-list::-webkit-scrollbar-thumb {
      background: rgba(255,215,0,0.5);
      border-radius: 3px;
    }
    
    .photo-card {
      flex-shrink: 0;
      width: 140px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 12px;
      overflow: hidden;
      scroll-snap-align: start;
    }
    
    .photo-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
    }
    
    .photo-card-info {
      padding: 8px;
      font-size: 11px;
    }
    
    .photo-card-direction {
      color: #ffd700;
      font-weight: bold;
      font-size: 14px;
    }
    
    .photo-card-time {
      color: rgba(255,255,255,0.6);
      margin-top: 2px;
    }
    
    .photo-card-delete {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background: rgba(239,68,68,0.9);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .photo-card {
      position: relative;
    }
    
    /* å‹•ä½œæŒ‰éˆ• */
    .action-buttons {
      display: none;
      gap: 10px;
      margin-top: 12px;
    }
    
    .action-buttons.show {
      display: flex;
    }
    
    .btn-action {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .btn-clear {
      background: rgba(239,68,68,0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }
    
    .btn-analyze {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
    }
    
    /* æç¤º */
    .hint {
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      margin-top: 12px;
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ§­ é¢¨æ°´ç¾…ç›¤</h1>
      <p>è¨˜éŒ„ç©ºé–“æ–¹ä½ï¼Œåˆ†æé¢¨æ°´æ ¼å±€</p>
    </div>
    
    <!-- æˆæ¬Šæç¤º (iPhone) -->
    <div class="permission-box" id="permission-box">
      <h3>ğŸ“± éœ€è¦ç¾…ç›¤æ¬Šé™</h3>
      <p>è«‹å…ˆæˆæ¬Šä½¿ç”¨æ‰‹æ©Ÿç¾…ç›¤åŠŸèƒ½</p>
      <button class="btn-permission" id="btn-permission" onclick="requestPermission()">
        ğŸ”“ é»æˆ‘æˆæ¬Šç¾…ç›¤
      </button>
    </div>
    
    <!-- å·²å•Ÿç”¨æç¤º (Android/å…¶ä»–) -->
    <div class="permission-box granted hidden" id="ready-box">
      <h3>âœ… ç¾…ç›¤å·²å•Ÿç”¨</h3>
      <p>è«‹å°æº–æ–¹å‘å¾Œæ‹ç…§è¨˜éŒ„</p>
    </div>
    
    <!-- ç¾…ç›¤ -->
    <div class="compass-section">
      <div class="compass-wrapper">
        <svg class="compass-svg" viewBox="0 0 260 260">
          <!-- å¤–åœˆæ¼¸å±¤ -->
          <defs>
            <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ffd700"/>
              <stop offset="100%" style="stop-color:#ff8c00"/>
            </linearGradient>
            <radialGradient id="bgGrad" cx="50%" cy="50%" r="50%">
              <stop offset="0%" style="stop-color:#2a2a4a"/>
              <stop offset="100%" style="stop-color:#0a0a1a"/>
            </radialGradient>
            <filter id="glow">
              <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          
          <!-- å¤–åœˆ -->
          <circle cx="130" cy="130" r="125" fill="url(#bgGrad)" stroke="url(#goldGrad)" stroke-width="3"/>
          
          <!-- åˆ»åº¦ -->
          <g id="ticks">
            <!-- æ¯ 10Â° çš„åˆ»åº¦ -->
            <script>
              // å‹•æ…‹ç”Ÿæˆåˆ»åº¦æœƒåœ¨ä¸‹é¢çš„ JS è™•ç†
            </script>
          </g>
          
          <!-- ä¸»è¦æ–¹ä½æ–‡å­— -->
          <text x="130" y="35" text-anchor="middle" fill="#ef4444" font-size="18" font-weight="bold" filter="url(#glow)">åŒ—</text>
          <text x="130" y="235" text-anchor="middle" fill="#ffd700" font-size="18" font-weight="bold">å—</text>
          <text x="230" y="135" text-anchor="middle" fill="#4ade80" font-size="18" font-weight="bold">æ±</text>
          <text x="30" y="135" text-anchor="middle" fill="#60a5fa" font-size="18" font-weight="bold">è¥¿</text>
          
          <!-- æ¬¡è¦æ–¹ä½ -->
          <text x="200" y="55" text-anchor="middle" fill="rgba(255,215,0,0.6)" font-size="12">æ±åŒ—</text>
          <text x="200" y="215" text-anchor="middle" fill="rgba(255,215,0,0.6)" font-size="12">æ±å—</text>
          <text x="60" y="215" text-anchor="middle" fill="rgba(255,215,0,0.6)" font-size="12">è¥¿å—</text>
          <text x="60" y="55" text-anchor="middle" fill="rgba(255,215,0,0.6)" font-size="12">è¥¿åŒ—</text>
          
          <!-- å…§åœˆ -->
          <circle cx="130" cy="130" r="60" fill="none" stroke="rgba(255,215,0,0.3)" stroke-width="1"/>
          <circle cx="130" cy="130" r="40" fill="none" stroke="rgba(255,215,0,0.2)" stroke-width="1"/>
        </svg>
        
        <!-- æŒ‡é‡ (ç¨ç«‹å±¤ï¼Œæœƒæ—‹è½‰) -->
        <div class="needle-wrapper" id="needle-wrapper">
          <svg viewBox="0 0 260 260" style="width:100%;height:100%;">
            <!-- åŒ—é‡ (ç´…) -->
            <polygon points="130,30 125,130 135,130" fill="#ef4444" filter="url(#glow)"/>
            <!-- å—é‡ (é‡‘) -->
            <polygon points="130,230 125,130 135,130" fill="#ffd700"/>
            <!-- ä¸­å¿ƒé» -->
            <circle cx="130" cy="130" r="12" fill="url(#goldGrad)"/>
            <circle cx="130" cy="130" r="6" fill="#1a1a2e"/>
          </svg>
        </div>
      </div>
      
      <!-- åº¦æ•¸é¡¯ç¤º -->
      <div class="degree-display">
        <div class="degree-value" id="degree-value">--Â°</div>
        <div class="direction-text" id="direction-text">ç­‰å¾…æˆæ¬Š...</div>
      </div>
    </div>
    
    <!-- æ‹ç…§å€å¡Š -->
    <div class="photo-section">
      <button class="btn-photo" id="btn-photo" onclick="takePhoto()" disabled>
        ğŸ“· æ‹ç…§è¨˜éŒ„æ–¹ä½
      </button>
      
      <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
      
      <!-- ç…§ç‰‡è¨ˆæ•¸ -->
      <div class="photo-count" id="photo-count" style="display:none;">
        å·²æ‹æ” <span id="count-number">0</span> å¼µç…§ç‰‡
      </div>
      
      <!-- ç…§ç‰‡åˆ—è¡¨ -->
      <div class="photo-list" id="photo-list"></div>
      
      <!-- å‹•ä½œæŒ‰éˆ• -->
      <div class="action-buttons" id="action-buttons">
        <button class="btn-action btn-clear" onclick="clearPhotos()">
          ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
        </button>
        <button class="btn-action btn-analyze" onclick="analyzeAll()">
          ğŸ”® åˆ†æé¢¨æ°´
        </button>
      </div>
      
      <p class="hint">å¯é€£çºŒæ‹æ”å¤šå¼µä¸åŒæ–¹ä½çš„ç…§ç‰‡</p>
    </div>
  </div>

  <script>
    let currentHeading = null;
    let photos = [];

    // ç”Ÿæˆåˆ»åº¦
    function generateTicks() {
      const ticksGroup = document.getElementById('ticks');
      let ticksHTML = '';
      
      for (let i = 0; i < 360; i += 5) {
        const angle = i * Math.PI / 180;
        const isMajor = i % 30 === 0;
        const isMedium = i % 10 === 0;
        
        const outerR = 120;
        const innerR = isMajor ? 100 : (isMedium ? 108 : 113);
        
        const x1 = 130 + outerR * Math.sin(angle);
        const y1 = 130 - outerR * Math.cos(angle);
        const x2 = 130 + innerR * Math.sin(angle);
        const y2 = 130 - innerR * Math.cos(angle);
        
        const strokeWidth = isMajor ? 2 : 1;
        const color = isMajor ? 'rgba(255,215,0,0.8)' : 'rgba(255,215,0,0.4)';
        
        ticksHTML += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${color}" stroke-width="${strokeWidth}"/>`;
        
        // åº¦æ•¸æ¨™ç±¤ (æ¯ 30Â°)
        if (isMajor && i !== 0 && i !== 90 && i !== 180 && i !== 270) {
          const labelR = 92;
          const lx = 130 + labelR * Math.sin(angle);
          const ly = 130 - labelR * Math.cos(angle) + 4;
          ticksHTML += `<text x="${lx}" y="${ly}" text-anchor="middle" fill="rgba(255,215,0,0.5)" font-size="10">${i}Â°</text>`;
        }
      }
      
      ticksGroup.innerHTML = ticksHTML;
    }

    // åˆå§‹åŒ–
    function init() {
      generateTicks();
      
      if (window.DeviceOrientationEvent) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          // iPhone iOS 13+ éœ€è¦è«‹æ±‚æ¬Šé™
          document.getElementById('permission-box').classList.remove('hidden');
          document.getElementById('ready-box').classList.add('hidden');
        } else {
          // Android æˆ–èˆŠç‰ˆ iOSï¼Œç›´æ¥å•Ÿç”¨
          document.getElementById('permission-box').classList.add('hidden');
          document.getElementById('ready-box').classList.remove('hidden');
          startCompass();
          enablePhotoButton();
          
          // 3ç§’å¾Œéš±è—æç¤º
          setTimeout(() => {
            document.getElementById('ready-box').classList.add('hidden');
          }, 3000);
        }
      } else {
        document.getElementById('direction-text').textContent = 'æ­¤è£ç½®ä¸æ”¯æ´ç¾…ç›¤';
        document.getElementById('permission-box').classList.add('hidden');
        document.getElementById('ready-box').classList.add('hidden');
      }
    }

    // è«‹æ±‚æ¬Šé™
    async function requestPermission() {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          document.getElementById('permission-box').classList.add('granted');
          document.getElementById('permission-box').querySelector('h3').textContent = 'âœ… å·²æˆæ¬Š';
          document.getElementById('permission-box').querySelector('p').textContent = 'ç¾…ç›¤åŠŸèƒ½å·²å•Ÿç”¨';
          document.getElementById('btn-permission').disabled = true;
          document.getElementById('btn-permission').textContent = 'âœ“ æˆæ¬ŠæˆåŠŸ';
          
          startCompass();
          enablePhotoButton();
          
          setTimeout(() => {
            document.getElementById('permission-box').classList.add('hidden');
          }, 1500);
        }
      } catch (error) {
        alert('è«‹æ±‚æ¬Šé™å¤±æ•—: ' + error.message);
      }
    }

    function enablePhotoButton() {
      document.getElementById('btn-photo').disabled = false;
    }

    function startCompass() {
      window.addEventListener('deviceorientation', handleOrientation);
      window.addEventListener('deviceorientationabsolute', handleOrientation);
    }

    function handleOrientation(event) {
      let heading;
      
      if (event.webkitCompassHeading !== undefined) {
        heading = event.webkitCompassHeading;
      } else if (event.alpha !== null) {
        heading = 360 - event.alpha;
        if (heading >= 360) heading -= 360;
        if (heading < 0) heading += 360;
      }
      
      if (heading !== undefined && !isNaN(heading)) {
        currentHeading = Math.round(heading);
        updateUI(currentHeading);
      }
    }

    function updateUI(heading) {
      document.getElementById('degree-value').textContent = heading + 'Â°';
      document.getElementById('needle-wrapper').style.transform = `rotate(${heading}deg)`;
      document.getElementById('direction-text').textContent = getDirectionText(heading);
    }

    function getDirectionText(h) {
      if (h >= 337.5 || h < 22.5) return 'åŒ—';
      if (h >= 22.5 && h < 67.5) return 'æ±åŒ—';
      if (h >= 67.5 && h < 112.5) return 'æ±';
      if (h >= 112.5 && h < 157.5) return 'æ±å—';
      if (h >= 157.5 && h < 202.5) return 'å—';
      if (h >= 202.5 && h < 247.5) return 'è¥¿å—';
      if (h >= 247.5 && h < 292.5) return 'è¥¿';
      if (h >= 292.5 && h < 337.5) return 'è¥¿åŒ—';
      return h + 'Â°';
    }

    function takePhoto() {
      document.getElementById('camera-input').click();
    }

    function handlePhoto(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        
        const photo = {
          id: Date.now(),
          image: e.target.result,
          time: timeStr,
          direction: currentHeading !== null ? getDirectionText(currentHeading) : 'æœªçŸ¥',
          degree: currentHeading !== null ? currentHeading + 'Â°' : '--',
          heading: currentHeading
        };
        
        photos.push(photo);
        renderPhotos();
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function renderPhotos() {
      const list = document.getElementById('photo-list');
      const count = document.getElementById('photo-count');
      const actions = document.getElementById('action-buttons');
      
      if (photos.length === 0) {
        list.innerHTML = '';
        count.style.display = 'none';
        actions.classList.remove('show');
        return;
      }
      
      count.style.display = 'block';
      document.getElementById('count-number').textContent = photos.length;
      actions.classList.add('show');
      
      list.innerHTML = photos.map(p => `
        <div class="photo-card">
          <button class="photo-card-delete" onclick="deletePhoto(${p.id})">Ã—</button>
          <img src="${p.image}" alt="ç…§ç‰‡">
          <div class="photo-card-info">
            <div class="photo-card-direction">${p.direction} ${p.degree}</div>
            <div class="photo-card-time">${p.time}</div>
          </div>
        </div>
      `).join('');
      
      // æ»¾å‹•åˆ°æœ€æ–°ç…§ç‰‡
      list.scrollLeft = list.scrollWidth;
    }

    function deletePhoto(id) {
      photos = photos.filter(p => p.id !== id);
      renderPhotos();
    }

    function clearPhotos() {
      if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç…§ç‰‡å—ï¼Ÿ')) {
        photos = [];
        renderPhotos();
      }
    }

    function analyzeAll() {
      if (photos.length === 0) {
        alert('è«‹å…ˆæ‹æ”è‡³å°‘ä¸€å¼µç…§ç‰‡');
        return;
      }
      
      // å„²å­˜åˆ° localStorage
      localStorage.setItem('fengshui_photos', JSON.stringify(photos));
      
      // çµ±è¨ˆæ–¹ä½
      const directions = photos.map(p => p.direction).join('ã€');
      
      alert(`ğŸ”® é¢¨æ°´åˆ†æåŠŸèƒ½é–‹ç™¼ä¸­ï¼\n\nå·²è¨˜éŒ„ ${photos.length} å¼µç…§ç‰‡\næ–¹ä½ï¼š${directions}\n\nä¹‹å¾Œæœƒæ ¹æ“šé€™äº›æ–¹ä½ + å‘½ç›¤ï¼Œçµ¦å‡ºå®Œæ•´çš„é¢¨æ°´å»ºè­°ï¼`);
    }

    init();
  </script>
</body>
</html>
