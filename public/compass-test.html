<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ§­ é¢¨æ°´ç¾…ç›¤ - Jå€‹æº–</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans TC', sans-serif;
      background: linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0d0d2b 100%);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* é ‚éƒ¨æ¨™é¡Œ */
    .header {
      text-align: center;
      padding: 20px 0;
    }
    
    .header h1 {
      font-size: 28px;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .header p {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }
    
    /* æˆæ¬Šæç¤ºå€å¡Š - è¶…ç´šæ˜é¡¯ */
    .permission-box {
      background: linear-gradient(135deg, rgba(255,107,107,0.3), rgba(255,159,67,0.3));
      border: 2px solid #ff6b6b;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      animation: pulse-border 2s infinite;
    }
    
    @keyframes pulse-border {
      0%, 100% { border-color: #ff6b6b; box-shadow: 0 0 20px rgba(255,107,107,0.3); }
      50% { border-color: #ffd700; box-shadow: 0 0 30px rgba(255,215,0,0.4); }
    }
    
    .permission-box.granted {
      background: linear-gradient(135deg, rgba(74,222,128,0.2), rgba(34,197,94,0.2));
      border-color: #4ade80;
      animation: none;
    }
    
    .permission-box h3 {
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .permission-box p {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 16px;
    }
    
    .btn-permission {
      width: 100%;
      padding: 16px 24px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #ff6b6b, #ff8c00);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-permission:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(255,107,107,0.4);
    }
    
    .btn-permission:disabled {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      cursor: default;
    }
    
    /* ç¾…ç›¤å€å¡Š */
    .compass-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    
    .compass-wrapper {
      position: relative;
      width: 280px;
      height: 280px;
    }
    
    /* å¤–åœˆè£é£¾ */
    .compass-outer {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        rgba(255,215,0,0.1) 0deg,
        rgba(255,140,0,0.2) 45deg,
        rgba(255,215,0,0.1) 90deg,
        rgba(255,140,0,0.2) 135deg,
        rgba(255,215,0,0.1) 180deg,
        rgba(255,140,0,0.2) 225deg,
        rgba(255,215,0,0.1) 270deg,
        rgba(255,140,0,0.2) 315deg,
        rgba(255,215,0,0.1) 360deg
      );
      border: 3px solid rgba(255,215,0,0.3);
      box-shadow: 
        0 0 30px rgba(255,215,0,0.2),
        inset 0 0 30px rgba(0,0,0,0.5);
    }
    
    /* å…«å¦åˆ»åº¦åœˆ */
    .compass-bagua {
      position: absolute;
      top: 15px;
      left: 15px;
      right: 15px;
      bottom: 15px;
      border-radius: 50%;
      border: 2px solid rgba(255,215,0,0.4);
      background: radial-gradient(circle, #1a1a3a 0%, #0a0a1a 100%);
    }
    
    /* å…§åœˆ */
    .compass-inner {
      position: absolute;
      top: 40px;
      left: 40px;
      right: 40px;
      bottom: 40px;
      border-radius: 50%;
      border: 2px solid rgba(255,215,0,0.6);
      background: radial-gradient(circle, #2a2a4a 0%, #1a1a3a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* æ–¹ä½æ¨™ç¤º */
    .direction-labels {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    
    .direction-labels span {
      position: absolute;
      font-weight: bold;
      font-size: 20px;
      text-shadow: 0 0 10px currentColor;
    }
    
    .direction-labels .n { top: 25px; left: 50%; transform: translateX(-50%); color: #ef4444; }
    .direction-labels .s { bottom: 25px; left: 50%; transform: translateX(-50%); color: #ffd700; }
    .direction-labels .e { right: 25px; top: 50%; transform: translateY(-50%); color: #4ade80; }
    .direction-labels .w { left: 25px; top: 50%; transform: translateY(-50%); color: #60a5fa; }
    
    /* å…«å¦ç¬¦è™Ÿ */
    .bagua-symbols {
      position: absolute;
      width: 100%;
      height: 100%;
      font-size: 16px;
      color: rgba(255,215,0,0.6);
    }
    
    .bagua-symbols span {
      position: absolute;
    }
    
    .bagua-symbols .ne { top: 45px; right: 45px; }
    .bagua-symbols .se { bottom: 45px; right: 45px; }
    .bagua-symbols .sw { bottom: 45px; left: 45px; }
    .bagua-symbols .nw { top: 45px; left: 45px; }
    
    /* æŒ‡é‡ */
    .compass-needle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 100px;
      margin-left: -3px;
      margin-top: -80px;
      transform-origin: 3px 80px;
      transition: transform 0.3s ease-out;
    }
    
    .needle-north {
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 70px solid #ef4444;
      margin-left: -3px;
      filter: drop-shadow(0 0 10px #ef4444);
    }
    
    .needle-south {
      position: absolute;
      bottom: -60px;
      left: 0;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 50px solid #ffd700;
      margin-left: -1px;
    }
    
    .needle-center {
      position: absolute;
      top: 65px;
      left: -7px;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #ffd700, #ff8c00);
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(255,215,0,0.6);
    }
    
    /* åº¦æ•¸é¡¯ç¤º */
    .degree-display {
      text-align: center;
      margin-top: 30px;
    }
    
    .degree-value {
      font-size: 56px;
      font-weight: bold;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
    }
    
    .direction-text {
      font-size: 24px;
      color: #4ade80;
      margin-top: 5px;
    }
    
    /* æ‹ç…§å€å¡Š */
    .photo-section {
      padding: 20px 0;
    }
    
    .btn-photo {
      width: 100%;
      padding: 18px 24px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      background: linear-gradient(135deg, #ffd700, #ff8c00);
      color: #1a1a2e;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 15px;
    }
    
    .btn-photo:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 30px rgba(255,215,0,0.4);
    }
    
    .btn-photo:disabled {
      background: #666;
      color: #999;
      cursor: not-allowed;
    }
    
    #camera-input {
      display: none;
    }
    
    /* ç…§ç‰‡çµæœå¡ç‰‡ */
    .photo-result {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,215,0,0.3);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 20px;
      display: none;
    }
    
    .photo-result.show {
      display: block;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .photo-result img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
    }
    
    .photo-info {
      padding: 15px;
    }
    
    .photo-info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .photo-info-row:last-child {
      border-bottom: none;
    }
    
    .photo-info-label {
      color: rgba(255,255,255,0.6);
    }
    
    .photo-info-value {
      font-weight: bold;
      color: #ffd700;
    }
    
    /* ä¸‹ä¸€æ­¥æŒ‰éˆ• */
    .next-actions {
      display: none;
      gap: 10px;
      margin-top: 15px;
    }
    
    .next-actions.show {
      display: flex;
    }
    
    .btn-action {
      flex: 1;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.2s;
    }
    
    .btn-action:hover {
      transform: scale(1.02);
    }
    
    .btn-share {
      background: linear-gradient(135deg, #60a5fa, #3b82f6);
      color: white;
    }
    
    .btn-analyze {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
    }
    
    /* æç¤ºæ–‡å­— */
    .hint {
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 13px;
      margin-top: 15px;
    }
    
    /* éš±è—ç‹€æ…‹ */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ§­ é¢¨æ°´ç¾…ç›¤</h1>
      <p>è¨˜éŒ„ç©ºé–“æ–¹ä½ï¼Œåˆ†æé¢¨æ°´æ ¼å±€</p>
    </div>
    
    <!-- æˆæ¬Šæç¤º - iPhone å°ˆç”¨ -->
    <div class="permission-box" id="permission-box">
      <h3>ğŸ“± éœ€è¦ç¾…ç›¤æ¬Šé™</h3>
      <p>ç‚ºäº†åµæ¸¬æ–¹ä½ï¼Œè«‹å…ˆæˆæ¬Šä½¿ç”¨æ‰‹æ©Ÿç¾…ç›¤åŠŸèƒ½</p>
      <button class="btn-permission" id="btn-permission" onclick="requestPermission()">
        <span>ğŸ”“</span>
        <span>é»æˆ‘æˆæ¬Šç¾…ç›¤</span>
      </button>
    </div>
    
    <!-- ç¾…ç›¤ -->
    <div class="compass-section">
      <div class="compass-wrapper">
        <div class="compass-outer"></div>
        <div class="compass-bagua"></div>
        <div class="compass-inner"></div>
        
        <!-- æ–¹ä½æ¨™ç¤º -->
        <div class="direction-labels">
          <span class="n">åŒ—</span>
          <span class="s">å—</span>
          <span class="e">æ±</span>
          <span class="w">è¥¿</span>
        </div>
        
        <!-- å…«å¦ç¬¦è™Ÿ -->
        <div class="bagua-symbols">
          <span class="ne">â˜°</span>
          <span class="se">â˜²</span>
          <span class="sw">â˜·</span>
          <span class="nw">â˜µ</span>
        </div>
        
        <!-- æŒ‡é‡ -->
        <div class="compass-needle" id="compass-needle">
          <div class="needle-north"></div>
          <div class="needle-south"></div>
          <div class="needle-center"></div>
        </div>
      </div>
      
      <!-- åº¦æ•¸é¡¯ç¤º -->
      <div class="degree-display">
        <div class="degree-value" id="degree-value">--Â°</div>
        <div class="direction-text" id="direction-text">ç­‰å¾…æˆæ¬Š...</div>
      </div>
    </div>
    
    <!-- æ‹ç…§å€å¡Š -->
    <div class="photo-section">
      <button class="btn-photo" id="btn-photo" onclick="takePhoto()" disabled>
        <span>ğŸ“·</span>
        <span>æ‹ç…§è¨˜éŒ„æ–¹ä½</span>
      </button>
      
      <input type="file" id="camera-input" accept="image/*" capture="environment" onchange="handlePhoto(event)">
      
      <!-- ç…§ç‰‡çµæœ -->
      <div class="photo-result" id="photo-result">
        <img id="photo-preview" src="" alt="ç…§ç‰‡é è¦½">
        <div class="photo-info">
          <div class="photo-info-row">
            <span class="photo-info-label">ğŸ“… æ™‚é–“</span>
            <span class="photo-info-value" id="photo-time">--</span>
          </div>
          <div class="photo-info-row">
            <span class="photo-info-label">ğŸ§­ æ–¹ä½</span>
            <span class="photo-info-value" id="photo-direction">--</span>
          </div>
          <div class="photo-info-row">
            <span class="photo-info-label">ğŸ“ è§’åº¦</span>
            <span class="photo-info-value" id="photo-degree">--</span>
          </div>
        </div>
      </div>
      
      <!-- ä¸‹ä¸€æ­¥æŒ‰éˆ• -->
      <div class="next-actions" id="next-actions">
        <button class="btn-action btn-share" onclick="sharePhoto()">
          <span>ğŸ“¤</span>
          <span>åˆ†äº«ç…§ç‰‡</span>
        </button>
        <button class="btn-action btn-analyze" onclick="analyzePhoto()">
          <span>ğŸ”®</span>
          <span>åˆ†æé¢¨æ°´</span>
        </button>
      </div>
      
      <p class="hint">æ‹ç…§å¾Œå¯åˆ†äº«æˆ–é€²è¡Œé¢¨æ°´åˆ†æ</p>
    </div>
  </div>

  <script>
    let currentHeading = null;
    let lastPhotoData = null;
    let permissionGranted = false;

    // åˆå§‹åŒ–
    function init() {
      if (window.DeviceOrientationEvent) {
        // iOS 13+ éœ€è¦è«‹æ±‚æ¬Šé™
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          document.getElementById('permission-box').classList.remove('hidden');
        } else {
          // Android æˆ–èˆŠç‰ˆ iOS
          document.getElementById('permission-box').classList.add('hidden');
          startCompass();
          enablePhotoButton();
        }
      } else {
        document.getElementById('direction-text').textContent = 'æ­¤è£ç½®ä¸æ”¯æ´ç¾…ç›¤';
      }
    }

    // è«‹æ±‚æ¬Šé™
    async function requestPermission() {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          permissionGranted = true;
          document.getElementById('permission-box').classList.add('granted');
          document.getElementById('permission-box').querySelector('h3').textContent = 'âœ… å·²æˆæ¬Š';
          document.getElementById('permission-box').querySelector('p').textContent = 'ç¾…ç›¤åŠŸèƒ½å·²å•Ÿç”¨';
          document.getElementById('btn-permission').disabled = true;
          document.getElementById('btn-permission').innerHTML = '<span>âœ“</span><span>æˆæ¬ŠæˆåŠŸ</span>';
          
          startCompass();
          enablePhotoButton();
          
          // 2ç§’å¾Œéš±è—æˆæ¬Šæ¡†
          setTimeout(() => {
            document.getElementById('permission-box').classList.add('hidden');
          }, 2000);
        } else {
          alert('éœ€è¦ç¾…ç›¤æ¬Šé™æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½');
        }
      } catch (error) {
        alert('è«‹æ±‚æ¬Šé™å¤±æ•—: ' + error.message);
      }
    }

    // å•Ÿç”¨æ‹ç…§æŒ‰éˆ•
    function enablePhotoButton() {
      document.getElementById('btn-photo').disabled = false;
    }

    // é–‹å§‹ç›£è½ç¾…ç›¤
    function startCompass() {
      window.addEventListener('deviceorientation', handleOrientation);
      window.addEventListener('deviceorientationabsolute', handleOrientation);
    }

    // è™•ç†æ–¹å‘è®ŠåŒ–
    function handleOrientation(event) {
      let heading;
      
      if (event.webkitCompassHeading !== undefined) {
        heading = event.webkitCompassHeading;
      } else if (event.alpha !== null) {
        heading = 360 - event.alpha;
        if (heading >= 360) heading -= 360;
        if (heading < 0) heading += 360;
      }
      
      if (heading !== undefined && !isNaN(heading)) {
        currentHeading = Math.round(heading);
        updateUI(currentHeading);
      }
    }

    // æ›´æ–° UI
    function updateUI(heading) {
      document.getElementById('degree-value').textContent = heading + 'Â°';
      document.getElementById('compass-needle').style.transform = `rotate(${heading}deg)`;
      
      const direction = getDirectionText(heading);
      document.getElementById('direction-text').textContent = direction;
    }

    // è§’åº¦è½‰æ–¹ä½
    function getDirectionText(heading) {
      if (heading >= 337.5 || heading < 22.5) return 'åŒ—';
      if (heading >= 22.5 && heading < 67.5) return 'æ±åŒ—';
      if (heading >= 67.5 && heading < 112.5) return 'æ±';
      if (heading >= 112.5 && heading < 157.5) return 'æ±å—';
      if (heading >= 157.5 && heading < 202.5) return 'å—';
      if (heading >= 202.5 && heading < 247.5) return 'è¥¿å—';
      if (heading >= 247.5 && heading < 292.5) return 'è¥¿';
      if (heading >= 292.5 && heading < 337.5) return 'è¥¿åŒ—';
      return heading + 'Â°';
    }

    // æ‹ç…§
    function takePhoto() {
      document.getElementById('camera-input').click();
    }

    // è™•ç†ç…§ç‰‡
    function handlePhoto(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const now = new Date();
        const timeStr = now.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        
        const direction = currentHeading !== null ? getDirectionText(currentHeading) : 'æœªçŸ¥';
        const degree = currentHeading !== null ? currentHeading + 'Â°' : 'æœªå–å¾—';
        
        lastPhotoData = {
          image: e.target.result,
          time: timeStr,
          direction: direction,
          degree: degree,
          heading: currentHeading
        };
        
        // é¡¯ç¤ºçµæœ
        document.getElementById('photo-preview').src = e.target.result;
        document.getElementById('photo-time').textContent = timeStr;
        document.getElementById('photo-direction').textContent = direction + ' (' + degree + ')';
        document.getElementById('photo-degree').textContent = degree;
        
        document.getElementById('photo-result').classList.add('show');
        document.getElementById('next-actions').classList.add('show');
      };
      reader.readAsDataURL(file);
      
      event.target.value = '';
    }

    // åˆ†äº«ç…§ç‰‡
    async function sharePhoto() {
      if (!lastPhotoData) return;
      
      const shareText = `ğŸ§­ é¢¨æ°´ç¾…ç›¤è¨˜éŒ„\nğŸ“… ${lastPhotoData.time}\nğŸ§­ æ–¹ä½ï¼š${lastPhotoData.direction}\nğŸ“ è§’åº¦ï¼š${lastPhotoData.degree}\n\nğŸ“ Jå€‹æº– é¢¨æ°´åˆ†æ`;
      
      if (navigator.share) {
        try {
          // å°‡ base64 è½‰æˆ blob
          const response = await fetch(lastPhotoData.image);
          const blob = await response.blob();
          const file = new File([blob], 'fengshui-photo.jpg', { type: 'image/jpeg' });
          
          await navigator.share({
            title: 'é¢¨æ°´ç¾…ç›¤è¨˜éŒ„',
            text: shareText,
            files: [file]
          });
        } catch (err) {
          // å¦‚æœåˆ†äº«å¤±æ•—ï¼Œè¤‡è£½æ–‡å­—
          copyToClipboard(shareText);
        }
      } else {
        copyToClipboard(shareText);
      }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
      }).catch(() => {
        alert('è«‹æ‰‹å‹•è¤‡è£½ï¼š\n' + text);
      });
    }

    // åˆ†æé¢¨æ°´ï¼ˆè·³è½‰åˆ°åˆ†æé é¢ï¼‰
    function analyzePhoto() {
      if (!lastPhotoData) return;
      
      // å„²å­˜åˆ° localStorage
      localStorage.setItem('fengshui_photo', JSON.stringify(lastPhotoData));
      
      // TODO: è·³è½‰åˆ°é¢¨æ°´åˆ†æé é¢
      alert('ğŸ”® é¢¨æ°´åˆ†æåŠŸèƒ½é–‹ç™¼ä¸­ï¼\n\nç›®å‰è¨˜éŒ„ï¼š\næ–¹ä½ï¼š' + lastPhotoData.direction + '\nè§’åº¦ï¼š' + lastPhotoData.degree + '\n\nä¹‹å¾Œæœƒæ ¹æ“šæ–¹ä½ + å‘½ç›¤ï¼Œçµ¦å‡ºé¢¨æ°´å»ºè­°ï¼');
    }

    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
