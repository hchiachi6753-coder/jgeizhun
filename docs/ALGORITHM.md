# J給準 - 紫微斗數算法規格書

> Algorithm Specification
> 
> 版本：1.0
> 更新日期：2026-02-18
> 作者：JJ & J1
> 
> ⚠️ 本文件記錄的規則是經過反覆測試，與「科技紫微網」結果比對後確認的正確算法。

---

## 1. 基礎概念

### 1.1 地支索引

| 地支 | 子 | 丑 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 |
|------|----|----|----|----|----|----|----|----|----|----|----|----|
| 索引 | 0  | 1  | 2  | 3  | 4  | 5  | 6  | 7  | 8  | 9  | 10 | 11 |

### 1.2 陰陽宮

```
陽宮（偶數索引）：子(0)、寅(2)、辰(4)、午(6)、申(8)、戌(10)
陰宮（奇數索引）：丑(1)、卯(3)、巳(5)、未(7)、酉(9)、亥(11)
```

**這是本算法的核心概念！** 星曜排列方式會根據主星所在宮位的陰陽屬性而調整。

---

## 2. 命宮計算

### 2.1 公式

```
命宮地支索引 = (14 - 農曆月份 - 時辰索引) mod 12
```

其中：
- 農曆月份：1-12
- 時辰索引：子時=0, 丑時=1, ..., 亥時=11

### 2.2 時辰轉換

```typescript
function getHourIndex(hour: number): number {
  // 23:00-00:59 = 子時(0)
  if (hour === 23 || hour === 0) return 0;
  // 其他時辰
  return Math.floor((hour + 1) / 2);
}
```

---

## 3. 五行局計算

### 3.1 納音五行局表

根據命宮地支和年干，查表得到五行局數。

| 命宮地支 | 甲己 | 乙庚 | 丙辛 | 丁壬 | 戊癸 |
|---------|------|------|------|------|------|
| 子丑    | 金4局 | 水2局 | 火6局 | 土5局 | 木3局 |
| 寅卯    | 水2局 | 火6局 | 土5局 | 木3局 | 金4局 |
| 辰巳    | 火6局 | 土5局 | 木3局 | 金4局 | 水2局 |
| 午未    | 土5局 | 木3局 | 金4局 | 水2局 | 火6局 |
| 申酉    | 木3局 | 金4局 | 水2局 | 火6局 | 土5局 |
| 戌亥    | 金4局 | 水2局 | 火6局 | 土5局 | 木3局 |

---

## 4. 紫微星位置計算

### 4.1 商餘閏宮法

```typescript
function calculateZiweiPosition(ju: number, day: number): number {
  // 計算商數
  const q = Math.ceil(day / ju);
  
  // 計算餘數 (1 ~ ju)
  const r = day - (q - 1) * ju;
  
  // 基礎位置 = 寅(2) + (商數 - 1)
  let pos = 2 + (q - 1);
  
  // 閏宮調整：若 1 < 餘數 < 局數，逆閏 (餘數-1) 位
  if (r > 1 && r < ju) {
    pos -= (r - 1);
  }
  
  // 確保結果在 0-11 範圍
  return ((pos % 12) + 12) % 12;
}
```

### 4.2 計算範例

```
案例：金四局，農曆27日

q = ceil(27 / 4) = 7
r = 27 - 6 × 4 = 3
基礎位置 = 2 + 6 = 8（申）
閏宮調整：1 < 3 < 4，逆閏 2 位
紫微位置 = 8 - 2 = 6（午）
```

---

## 5. 紫微星系安置 ⭐

### 5.1 規則說明

紫微星系的排列方式取決於**紫微所在宮位的陰陽屬性**：

#### 紫微在陰宮（丑卯巳未酉亥）時：

```
紫微 → 天機(-1) → [空] → 太陽(-3) → 武曲(-4) → 天同(-5) → [空×3] → 廉貞(-8)
```

| 星名 | 偏移 |
|------|------|
| 紫微 | 0 |
| 天機 | -1 |
| 太陽 | **-3** |
| 武曲 | **-4** |
| 天同 | **-5** |
| 廉貞 | -8 |

#### 紫微在陽宮（子寅辰午申戌）時：

```
紫微 → 天機(-1) → 太陽(-2) → 武曲(-3) → 天同(-4) → [空×4] → 廉貞(-8)
```

| 星名 | 偏移 |
|------|------|
| 紫微 | 0 |
| 天機 | -1 |
| 太陽 | **-2** |
| 武曲 | **-3** |
| 天同 | **-4** |
| 廉貞 | -8 |

### 5.2 程式碼實作

```typescript
export function calculateZiweiStars(ziweiPos: number): Record<string, number> {
  // 判斷紫微是否在陰宮（奇數位置）
  const isYinGong = ziweiPos % 2 === 1;
  
  const offsets = isYinGong ? {
    '紫微': 0, '天機': -1, '太陽': -3, '武曲': -4, '天同': -5, '廉貞': -8
  } : {
    '紫微': 0, '天機': -1, '太陽': -2, '武曲': -3, '天同': -4, '廉貞': -8
  };

  const stars: Record<string, number> = {};
  for (const [star, offset] of Object.entries(offsets)) {
    stars[star] = (ziweiPos + offset + 12) % 12;
  }
  return stars;
}
```

---

## 6. 天府對稱表 ⭐

### 6.1 紫微與天府的對稱關係

天府的位置由紫微位置查表決定：

| 紫微位置 | 天府位置 | 備註 |
|---------|---------|------|
| 子(0) | 辰(4) | |
| 丑(1) | 卯(3) | |
| 寅(2) | 寅(2) | 同宮 |
| 卯(3) | 丑(1) | |
| 辰(4) | 子(0) | |
| 巳(5) | 亥(11) | |
| **午(6)** | **申(8)** | ⚠️ 注意！不是戌(10) |
| 未(7) | 酉(9) | |
| **申(8)** | **午(6)** | ⚠️ 注意！不是申(8) |
| 酉(9) | 未(7) | |
| **戌(10)** | **辰(4)** | ⚠️ 注意！不是午(6) |
| 亥(11) | 巳(5) | |

### 6.2 程式碼實作

```typescript
const tianfuMap: Record<number, number> = {
  0: 4,   // 紫微子 -> 天府辰
  1: 3,   // 紫微丑 -> 天府卯
  2: 2,   // 紫微寅 -> 天府寅
  3: 1,   // 紫微卯 -> 天府丑
  4: 0,   // 紫微辰 -> 天府子
  5: 11,  // 紫微巳 -> 天府亥
  6: 8,   // 紫微午 -> 天府申 ⚠️
  7: 9,   // 紫微未 -> 天府酉
  8: 6,   // 紫微申 -> 天府午 ⚠️
  9: 7,   // 紫微酉 -> 天府未
  10: 4,  // 紫微戌 -> 天府辰 ⚠️
  11: 5,  // 紫微亥 -> 天府巳
};
```

---

## 7. 天府星系安置 ⭐

### 7.1 規則說明

天府星系的排列方式取決於**天府所在宮位的陰陽屬性**：

#### 天府在陰宮（丑卯巳未酉亥）時：緊密排列

```
天府 → 太陰(+1) → 貪狼(+2) → 巨門(+3) → 天相(+4) → 天梁(+5) → 七殺(+6) → [空×3] → 破軍(+10)
```

| 星名 | 偏移 |
|------|------|
| 天府 | 0 |
| 太陰 | +1 |
| 貪狼 | +2 |
| 巨門 | **+3** |
| 天相 | **+4** |
| 天梁 | **+5** |
| 七殺 | **+6** |
| 破軍 | +10 |

#### 天府在陽宮（子寅辰午申戌）時：跳格排列

```
天府 → 太陰(+1) → 貪狼(+2) → [空] → 巨門(+4) → 天相(+5) → 天梁(+6) → 七殺(+7) → [空×2] → 破軍(+10)
```

| 星名 | 偏移 |
|------|------|
| 天府 | 0 |
| 太陰 | +1 |
| 貪狼 | +2 |
| 巨門 | **+4** |
| 天相 | **+5** |
| 天梁 | **+6** |
| 七殺 | **+7** |
| 破軍 | +10 |

### 7.2 程式碼實作

```typescript
export function calculateTianfuStars(ziweiPos: number): Record<string, number> {
  const tianfuPos = tianfuMap[ziweiPos];
  
  // 判斷天府是否在陰宮（奇數位置）
  const isYinGong = tianfuPos % 2 === 1;

  const offsets = isYinGong ? {
    '天府': 0, '太陰': 1, '貪狼': 2, '巨門': 3,
    '天相': 4, '天梁': 5, '七殺': 6, '破軍': 10
  } : {
    '天府': 0, '太陰': 1, '貪狼': 2, '巨門': 4,
    '天相': 5, '天梁': 6, '七殺': 7, '破軍': 10
  };

  const stars: Record<string, number> = {};
  for (const [star, offset] of Object.entries(offsets)) {
    stars[star] = (tianfuPos + offset) % 12;
  }
  return stars;
}
```

---

## 8. 輔煞星安置

### 8.1 左輔右弼（根據月份）

```
左輔：辰(4)起正月，順行
右弼：戌(10)起正月，逆行

左輔位置 = (4 + 月份 - 1) mod 12
右弼位置 = (10 - 月份 + 1 + 12) mod 12
```

### 8.2 文昌文曲（根據時辰）

```
文昌：戌(10)起子時，逆行
文曲：辰(4)起子時，順行

文昌位置 = (10 - 時辰索引 + 12) mod 12
文曲位置 = (4 + 時辰索引) mod 12
```

### 8.3 天魁天鉞（根據年干）

| 年干 | 天魁 | 天鉞 |
|------|------|------|
| 甲、戊、庚 | 丑(1) | 未(7) |
| 乙、己 | 子(0) | **申(8)** |
| 丙、丁 | 亥(11) | 酉(9) |
| 壬、癸 | 卯(3) | 巳(5) |
| 辛 | 午(6) | 寅(2) |

### 8.4 火星鈴星（根據年支和時辰）

```
火星起始位置（根據年支）：
  寅午戌年：丑(1)起子時
  申子辰年：寅(2)起子時
  巳酉丑年：卯(3)起子時
  亥卯未年：酉(9)起子時

火星位置 = (起始位置 + 時辰索引) mod 12

鈴星起始位置（根據年支）：
  寅午戌年：寅(2)起子時
  其他年：戌(10)起子時

鈴星位置 = (起始位置 + 時辰索引) mod 12
```

### 8.5 擎羊陀羅（根據祿存位置）

```
擎羊 = 祿存 + 1
陀羅 = 祿存 - 1
```

### 8.6 地空地劫（根據時辰）

```
地空：亥(11)起子時，逆行
地劫：亥(11)起子時，順行

地空位置 = (11 - 時辰索引 + 12) mod 12
地劫位置 = (11 + 時辰索引) mod 12
```

### 8.7 祿存（根據年干）

| 年干 | 祿存位置 |
|------|---------|
| 甲 | 寅(2) |
| 乙 | 卯(3) |
| 丙、戊 | 巳(5) |
| 丁、己 | 午(6) |
| 庚 | 申(8) |
| 辛 | 酉(9) |
| 壬 | 亥(11) |
| 癸 | 子(0) |

### 8.8 天馬（根據年支）

| 年支 | 天馬位置 |
|------|---------|
| 寅、午、戌 | 申(8) |
| 申、子、辰 | 寅(2) |
| 巳、酉、丑 | 亥(11) |
| 亥、卯、未 | 巳(5) |

---

## 9. 驗證測試

### 9.1 測試案例 A

```
輸入：1985年8月6日 申時 男命
農曆：乙丑年6月20日

預期結果：
- 五行局：土五局
- 命宮：丁亥
- 紫微位置：巳(5) ← 陰宮
- 天府位置：亥(11) ← 陰宮

主星分布：
- 命宮(亥)：天府
- 夫妻(酉)：廉貞、破軍
- 遷移(巳)：紫微、七殺
- 交友(辰)：天機、天梁
- 官祿(卯)：天相
- 田宅(寅)：太陽、巨門
- 福德(丑)：武曲、貪狼
- 父母(子)：天同、太陰
```

### 9.2 測試案例 B

```
輸入：1966年6月2日 卯時 男命
農曆：丙午年4月14日

預期結果：
- 五行局：木三局
- 命宮：庚寅
- 紫微位置：巳(5) ← 陰宮
- 天府位置：亥(11) ← 陰宮

主星分布：
- 命宮(寅)：太陽、巨門
- 兄弟(丑)：武曲、貪狼
- 夫妻(子)：天同、太陰
- 子女(亥)：天府
- 財帛(戌)：（空）
- 疾厄(酉)：廉貞、破軍
- 遷移(申)：（空）
- 交友(未)：左輔、右弼、文昌、文曲（四星同宮！）
- 官祿(午)：擎羊
- 田宅(巳)：紫微、七殺、祿存、鈴星
- 福德(辰)：天機、天梁、陀羅、火星
- 父母(卯)：天相
```

### 9.3 測試案例 C

```
輸入：1974年4月19日 未時 女命
農曆：甲寅年3月27日

預期結果：
- 五行局：金四局
- 命宮：癸酉
- 紫微位置：午(6) ← 陽宮
- 天府位置：申(8) ← 陽宮

主星分布：
- 命宮(酉)：太陰
- 兄弟(申)：天府
- 子女(午)：紫微、破軍
- 財帛(巳)：天機
- 疾厄(辰)：太陽
- 遷移(卯)：武曲、七殺
- 交友(寅)：天同、天梁
- 官祿(丑)：天相
- 田宅(子)：巨門
- 父母(戌)：廉貞、貪狼
```

---

## 10. 重要發現記錄

### 10.1 陰陽宮規則的發現過程

2026-02-18，經過與科技紫微網反覆比對，發現：

1. 紫微星系和天府星系的排列不是固定偏移
2. 偏移量會根據主星所在宮位的「陰陽屬性」動態調整
3. 這個規則在大部分紫微斗數教科書中沒有明確說明

### 10.2 天府對稱表的修正

原本使用的標準對稱表在某些位置有誤：

| 紫微 | 標準表 | 實際(科技紫微網) |
|------|--------|-----------------|
| 午(6) | 戌(10) | **申(8)** |
| 申(8) | 申(8) | **午(6)** |
| 戌(10) | 午(6) | **辰(4)** |

### 10.3 總結

> **陰宮緊密排，陽宮要跳格**

這句話是本算法的核心精髓。

---

## 11. 參考資料

- 科技紫微網 (https://ziwei.com.tw) - 計算結果驗證標準
- 《紫微斗數全書》
- 《紫微斗數講義》
- 知識庫古籍（12本）

---

## 12. 版本歷史

| 版本 | 日期 | 變更內容 |
|------|------|----------|
| 1.0 | 2026-02-18 | 初版，包含完整算法規格 |
| 1.1 | 2026-02-18 | 新增測試案例 B (1966/6/2)，驗證通過 |
